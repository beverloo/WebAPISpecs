<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">

<head>

<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>Web Telephony API</title>
<link rel="stylesheet" type="text/css" href="http://www.whatwg.org/style/specification">

<style>
   .domintro:before { display: table; margin: -1em -0.5em -0.5em auto; width: auto; content:
   'This box is non-normative. Implementation requirements are given below this box.';
   color: black; font-style: italic; border: solid 2px; background: white; padding: 0 0.25em;
   }
  </style>

<body class="draft">

<div class="head">
	<h1>[TITLE]</h1>
	
	<h2 class="no-num no-toc">Working Draft â€” [DATE]</h2>
	
	<dl>
		<dt>This version:
		<dd><!--begin-link-->http://example.com/<!--end-link-->
		
		<dt>Latest version:
		<dd><!--begin-link-->http://example.com/<!--end-link-->
		
		<dt>Previous versions:
		<dd><!--begin-link-->http://example.com/<!--end-link-->
		<dd><!--begin-link-->http://example.com/<!--end-link-->
		<dd><!--begin-link-->http://example.com/<!--end-link-->
		
		<dt>Editors:
		<dd class="vcard">
			<span class="fn">Jose M. Cantera</span>,
			<span class="org">Telefonica I+D</span>,
			<span class="email">jmcf@tid.es</span>
	</dl>
	
	<p class="copyright">.
	<p class="copyright">You are granted a license to do absolutely anything
	with this document, including removing this copyright notice.
</div>

<h2 class="no-num no-toc">Abstract</h2>

<p>This specification defines the Web Telephony API which offers a simple interface to manage telephony calls.

<h2 class="no-num no-toc">Status</h2>

<p>This is a <strong>work in progress</strong> and may change everyday.

<p>This specification is being produced under the WAC DAP LPWG and the B2G Mozilla Project.


<h2 class="no-num no-toc">Table of Contents</h2>

<!--toc-->

<h2>Introduction</h2>

<p>The Web Telephony API allows to control the lifecycle of a telephone call from a Web Application. 
<p>An example of use is provided below

<pre class="example">
	
var call = navigator.telephony.newCall('+34638883076');
call.onreadystatechange = function() { 
            if (this.readyState == 'connected')
                 window.console.log('Connected!'); 
}

call.onerror = function(e) {
	window.console.error(e);
}

call.connect();

</pre>

<h2>Conformance</h2>

 <p>All diagrams, examples, and notes in this specification are
  non-normative, as are all sections explicitly marked non-normative.
  Everything else in this specification is normative.

  <p>The key words "MUST", "MUST NOT", "REQUIRED", <!--"SHALL", "SHALL
  NOT",--> "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
  "OPTIONAL" in the normative parts of this document are to be
  interpreted as described in RFC2119. For readability, these words do
  not appear in all uppercase letters in this specification. <a
  href="#refsRFC2119">[RFC2119]</a>

<p>
        This specification defines conformance criteria that apply to a single product: the 
        <dfn id="ua">user agent</dfn> that implements the interfaces that it contains.

<h2>Security and Privacy Considerations</h2>
   <p>To be written
<p>

<h2>API Description</h2>

<h3>The Telephony interface</h3>
<p>The <code>Telephony</code> interface represents the initial entry point for getting access to telephony services.

<pre class="idl">
interface <dfn>Telephony</dfn> : <span>EventTarget</span> {
   Call <span title="telephony-newcall">newCall</span>(in DOMString number); 
   readonly attribute object? <span title="telephony-active">active</span>;   
   readonly attribute Call[] <span title="telephony-calls">calls</span>;    

   readonly attribute Microphone <span title="telephony-mic">mic</span>;
   readonly attribute Speaker <span title="telephony-speaker">speaker</span>;

   attribute <span>Function</span>? <span title="handler-onincomingcall">onincomingcall</span>;   

   attribute boolean <span title="telephony-doNotDisturb">doNotDisturb</span>;    
 }
</pre>

<dl class="domintro">
   <dt><var title="">navigator.telephony</var> . <code title="telephony-newCall">newCall</code>(number)</dt>
   <dd>
    <p>Allows to instantiate a new <code>Call</code> object that intended to manage a telephone call</p>
   </dd>
   
   <dt><var title="">navigator.telephony</var> . <code title="telephony-active">active</code></dt>
   <dd>
	<p>Returns the active <code>Call</code>. A call is considered 'active' if it is in the 'connected' state.
   </dd>

   <dt><var title="">navigator.telephony</var> . <code title="telephony-calls">calls</code></dt>
   <dd>
	<p>Returns an array with the list of instantiated calls. The attribute must be initialized to an empty array.
   </dd>

   <dt><var title="">navigator.telephony</var> . <code title="telephony-mic">mic</code></dt>
   <dd>
	<p>Returns a reference to the Microphone
   </dd>

   <dt><var title="">navigator.telephony</var> . <code title="telephony-speaker">speaker</code></dt>
   <dd>
	<p>Returns a reference to the Speaker
   </dd>

  <dt><var title="">navigator.telephony</var> . <code title="telephony-doNotDisturb">doNotDisturb</code></dt>
   <dd>
	<p>Allows to disable incoming calls. 
   </dd>

<dt><var title="">navigator.telephony</var> . <code title="telephony-onincomingcall">onincomingcall</code></dt>
   <dd>
	<p>Reference to an event handler associated to the <code title="event-incomingcall">incomingcall</code> DOM Event.
   </dd>
</dl>

<div class="impl">

<p>The IDL attribute <dfn title="telephony-active"><code>active</code></dfn> must return a <code>Call</code> object if there is a call in the 'connected' state. Otherwise it must return 'null'.

<p>The IDL attribute <dfn  title="telephony-calls"><code>calls</code></dfn> must return an array of all <code>Call</code> objects which are not in the disconnected state.

<p>The IDL attribute <dfn  title="telephony-mic"><code>mic</code></dfn> must return a reference to the <code>Microphone</code> object.

<p>The IDL attribute <dfn  title="telephony-speaker"><code>speaker</code></dfn> must return a reference to the <code>Speaker</code> object.

<p>The IDL attribute <dfn  title="telephony-doNotDisturb"><code>doNotDisturb</code></dfn> is a 
  <span>boolean attribute</span> that controls whether incoming calls are enabled, potentially
  overriding user preferences. The attribute must initially be false.

<p>The IDL attribute <dfn title="handler-onincomingcall"><code>onincomingcall</code></dfn> is an event handler for the <code title="event-incomingcall">incomingcall</code> DOM Event.


<p> The <dfn title="telephony-newCall"><code>newCall</code></dfn> method when invoked it must run the following steps:

  <ol>

   <li><p>Let <var title="">calls</var> be <span>the array of instantiated calls</span>. 
   <li><p>If <var>calls</var> contains a <code>Call</code> object corresponding to the telephone number passed as parameter, then return such a <code>Call</code> object.
   <li><p>Otherwise create a new <code>Call</code> object and:
   <ol>
	<li>set  <var>readyState</var> to 'new'  </li>
        <li>set  <var>caller</var> to the user MSISDN </li>
        <li>set <var>called</var> to the telephone number passed as parameter</li>
        <li>add the <code>Call</code> object to the <var>calls</var> array</li>
   </ol>  
 </ol>

</div>

<h3>The Call interface</h3>

<p>The <code>Call</code> interface represents a telephony call

<pre class="idl">

interface <dfn>Call</dfn> : <span>EventTarget</span> {
   readonly attribute DOMString? <span title="call-caller">caller</span>;     
   readonly attribute DOMString <span title="call-called">called</span>;

   attribute boolean <span title="call-hideNumber">hideNumber</span>;  

   readonly attribute double? <span title="call-duration">duration</span>;


   readonly attribute DOMString? <span title="call-readyState">readyState</span>; 

   attribute Function? <span title="handler-onconnect">onconnect</span>;
   attribute Function? <span title="handler-ondisconnect">ondisconnect</span>;
   attribute Function? <span title="handler-onreadystatechange">onreadystatechange</span>;
   attribute Function? <span title="handler-onerror">onerror</span>;

   void <span title="call-connect">connect</span>();

   void <span title="call-sendTones">sendTones</span>(DOMString tones,
                 optional unsigned long toneDuration,
                 optional unsigned long intervalDuration);

   void <span title="call-answer">answer</span>(); 

   void <span title="call-disconnect">disconnect</span>();

   void <span title="call-hold">hold</span>();

   void <span title="call-resume">resume</span>();
  }


</pre>

<dl class="domintro">
  <dt><var title="">call</var> . <code title="call-connect">connect</code>()</dt>
    <dd>
        <p>Request to initiate a telephone call</p>
   </dd>

 <dt><var title="">call</var> . <code title="call-disconnect">disconnect</code>()</dt>
    <dd>
        <p>Request to end (hang) a telephone call</p>
   </dd>

  <dt><var title="">call</var> . <code title="call-hold">hold</code>()</dt>
    <dd>
        <p>Request to put on hold a telephone call</p>
   </dd>

   <dt><var title="">call</var> . <code title="call-resume">resume</code>()</dt>
    <dd>
        <p>Request to resume a telephone call that has been previously put on hold</p>
   </dd>

  <dt><var title="">call</var> . <code title="call-answer">answer</code>()</dt>
    <dd>
        <p>Request to answer an incoming call</p>
   </dd>

  <dt><var title="">call</var> . <code title="call-sendtones">sendTones</code>(tones,toneDuration,intervalDuration)</dt>
    <dd>
        <p>Request to send tones of a certain duration during a particular interval</p>
   </dd>

  <dt><var title="">call</var> . <code title="call-caller">caller</code></dt>
    <dd>
        <p>Returns who is calling. </p>
   </dd>

 <dt><var title="">call</var> . <code title="call-called">called</code></dt>
    <dd>
        <p>Returns who is being called. </p>
   </dd>

  <dt><var title="">call</var> . <code title="call-duration">duration</code></dt>
    <dd>
        <p>Duration of the call in seconds. </p>
   </dd>

   <dt><var title="">call</var> . <code title="call-hideNumber">hideNumber</code></dt>
    <dd>
        <p>If true indicates that it will be requested to hide the caller number. </p>
   </dd>

<dt><var title="">call</var> . <code title="call-readyState">readyState</code></dt>
    <dd>
        <p>The status of the call: ("new", "connecting","alerting","connected","disconnecting","disconnected","onhold","incoming")</p>
    </dd>
</dl>


<div class="impl">
   <p>The IDL attribute <dfn title="call-caller"><code>caller</code></dfn> must return a DOMString corresponding to the MSISDN of the party who is calling. If the MSISDN is not disclosed then it must return null

<p>The IDL attribute <dfn title="call-called"><code>called</code></dfn> must return a DOMString corresponding to the MSISDN of the party who is being called. 

<p>The IDL attribute <dfn title="call-duration"><code>duration</code></dfn> must return the duration of the call in seconds if the <var>readyState</var> attribute is not equal to 'new'. Otherwise it must return null. 

<p>The IDL attribute <dfn title="call-hideNumber"><code>hideNumber</code></dfn> allows to control whether the call will disclose the origin number or not. It must be initialized to the false value. 

<p>The IDL attribute <dfn title="call-readyState"><code>readyState</code></dfn> must return the current status of the call. It must be one of the following values: 


<dl>
	<dt><dfn title="call-status-new"><code>new</code></dfn> (string value 'new')</dt>
	<dd>The call handler object has been instantiated and no other interaction has taken place</dd>
        <dt><dfn title="call-status-connecting"><code>connecting</code></dfn> (string value 'connecting')</dt>
	<dd>A request to establish the call has been made and it is progressing</dd>
        <dt><dfn title="call-status-alerting"><code>alerting</code></dfn> (string value 'alerting')</dt>
	<dd>The destination number has been reached and alerting is taking place</dd>
        <dt><dfn title="call-status-connected"><code>connected</code></dfn> (string value 'connected')</dt>
	<dd>The call is ongoing</dd>
        <dt><dfn title="call-status-disconnecting"><code>disconnecting</code></dfn> (string value 'disconnecting')</dt>
	<dd>A request to disconnect the call has been made and it is progressing</dd>
        <dt><dfn title="call-status-disconnected"><code>disconnected</code></dfn> (string value 'disconnected')</dt>
	<dd>The call has been disconnected</dd>
        <dt><dfn title="call-status-onhold"><code>onhold</code></dfn> (string value 'onhold')</dt>
	<dd>The call has been put on hold</dd>
        <dt><dfn title="call-status-incoming"><code>incoming</code></dfn> (string value 'incoming')</dt>
	<dd>An incoming call who has not been answered yet.</dd>
</dl>

<p>The IDL attribute <dfn title="handler-onreadystatechange"><code>onreadystatechange</code></dfn> is an event handler for the <code>readystatechange</code> DOM Event

<p>The IDL attribute <dfn title="handler-onconnect"><code>onconnect</code></dfn> is an event handler that must be invoked when a call reaches the 'connected' state. 

<p>The IDL attribute <dfn title="handler-ondisconnect"><code>ondisconnect</code></dfn> is an event handler that must be invoked when a call reaches the 'disconnected' state.

<p>The IDL attribute <dfn title="handler-onerror"><code>onerror</code></dfn> is an event handler that must be invoked when an error occurs.

<p>The <dfn title="call-connect"><code>connect</code></dfn> method when invoked must run the following steps:

<ol>
	<li><p>If the value of readyState is 'connected' raise an <code>INVALID_STATE</code> exception
	<li><p>Otherwise make a request to the telephony system to dial in the telephone number in the <code>called</code> attribute. If the request is acknowledged then <li><p>Set  <var>readyState</var> to 'connecting'. <span>queue a task</span> to <span>fire a simple event</span> named  <code title="event-Call-readystatechange">readystatechange</code>. And finally return to the caller and <span>queue a task</span> to monitor call connection progress. If there is an error invoke the onerror event handler.
</ol>

<p>The task in charge of monitoring call progress once it is notified of call connection it must set <var>readyState</var> to 'connected' and <span>queue a task</span> to <span>fire a simple event</span> named  <code title="event-Call-readystatechange">readystatechange</code>. 
<p>The task in charge of monitoring call progress when it is notified of call alerting tones it must set <var>readyState</var> to 'alerting' and <span>queue a task</span> to <span>fire a simple event</span> named  <code title="event-Call-readystatechange">readystatechange</code>.
If the call is not finally answered such a task must set <var>readyState</var> to 'disconnected' and <span>queue a task</span> to <span>fire a simple event</span> named  <code title="event-Call-readystatechange">readystatechange</code>. If there is any error the onerror handler must be invoked. 

<p>The <dfn title="call-disconnect"><code>disconnect</code></dfn> method when invoked must run the following steps:

<ol>
	<li><p>If <var>readyState</var> is not equal to 'connecting', 'alerting', 'connected' or 'onhold' raise an <code>INVALID_STATE</code> exception
        <li><p>Otherwise make a request to the telephony system to hang up the call. If the request is acknowledged then set <var>readyState</var> to 'disconnecting'. 
        <li><p><span>queue a task</span> to <span>fire a simple event</span> named  <code title="event-Call-readystatechange">readystatechange</code>
  at the <code>Call</code>. And finally return to the caller and <span>queue a task</span> to receive disconnecting progress. 
        <li><p>If there is an error invoke the onerror eventhandler. 
</ol>

<p>The task in charge of monitor call disconnection progress once it is notified of call disconnection it must set <var>readyState</var> to 'disconnected' and <span>queue a task</span> to <span>fire a simple event</span> named  <code title="event-Call-readystatechange">readystatechange</code>. If there is any error the onerror handler must be invoked. 

<p>The <dfn title="call-hold"><code>hold</code></dfn> method when invoked must run the following steps:

<ol>
	<li><p>If <var>readyState</var> is not equal to 'connected'  raise an <code>INVALID_STATE</code> exception
        <li><p>Otherwise make a request to the telephony system to hold the call. If the request is acknowledged then set <var>readyState</var> to 'onhold'. 
        <li><p><span>queue a task</span> to <span>fire a simple event</span> named  <code title="event-Call-readystatechange">readystatechange</code>
  at the <code>Call</code>. And finally return to the caller
        <li><p>If there is an error invoke the onerror eventhandler. 
</ol>

<p>The <dfn title="call-resume"><code>resume</code></dfn> method when invoked must run the following steps:

<ol>
	<li><p>If <var>readyState</var> is not equal to 'onhold' raise an <code>INVALID_STATE</code> exception
        <li><p>Otherwise make a request to the telephony system to resume the call. If the request is acknowledged then set <var>readyState</var> to 'connected'. 
        <li><p><span>queue a task</span> to <span>fire a simple event</span> named  <code title="event-Call-readystatechange">readystatechange</code>
  at the <code>Call</code>. And finally return to the caller
        <li><p>If there is an error invoke the onerror eventhandler. 
</ol>

<p>The <dfn title="call-answer"><code>answer</code></dfn> method when invoked must run the following steps:

<ol>
	<li><p>If <var>readyState</var> is not equal to 'incoming' raise an <code>INVALID_STATE</code> exception
        <li><p>Otherwise make a request to the telephony system to answer the call. If the request is acknowledged then set <var>readyState</var> to 'connecting'. 
        <li><p> <span>queue a task</span> to <span>fire a simple event</span> named  <code title="event-Call-readystatechange">readystatechange</code>
  at the <code>Call</code>. And finally return to the caller and set up all the infrastructure to receive connecting progress
        <li><p>If there is an error invoke the onerror eventhandler. 
</ol>

<p>The <dfn title="call-sendTones"><code>sendTones</code></dfn> method when invoked must run the following steps:

<ol>
	<li><p>If <var>readyState</var> is not equal to 'connected' raise an <code>INVALID_STATE</code> exception
        <li><p>Otherwise make a request to the telephony system to send the tones to the current call. If the request is acknowledged then return to the caller
        <li><p>If there is an error invoke the onerror eventhandler. 
</ol>

</div>


<h3>The Speaker interface</h3>

<p>The <code>Speaker</code> interface allows to control the Speaker hardware associated to telephone calls. 

<pre class="idl">

interface <dfn>Speaker</dfn> {
   void <span title="speaker-on">on</span>();
   
   void <span title="speaker-off">off</span>();
 
   attribute double <span title="speaker-volume">volume</span>; 
  }

</pre>

<dl class="domintro">
  <dt><var title="">speaker</var> . <code title="speaker-on">on</code>()</dt>
    <dd>
        <p>Request to turn on the speaker</p>
   </dd>

  <dt><var title="">speaker</var> . <code title="speaker-off">off</code>()</dt>
    <dd>
        <p>Request to turn off the speaker</p>
   </dd>

  <dt><var title="">speaker</var> . <code title="speaker-off">volume</code></dt>
    <dd>
        <p>Returns the current speaker volume multiplier, as a number in
    the range 0.0 to 1.0, where 0.0 is the quietest and 1.0 the
    loudest.
<p>Can be set, to change the volume multiplier.</p>

    <p>Throws an <code>INDEX_SIZE_ERR</code> if the new value is not
    in the range 0.0 .. 1.0.</p>

   </dd>
</dl>

<div class="impl">

        <p>The <dfn title="speaker-volume"><code>volume</code></dfn> attribute 
  attribute, on getting, must return the   <code>Speaker</code>'s <span> volume
  multiplier</span>, and on setting, if the new value is in the range
  0.0 to 1.0 inclusive, must set the <code>Speaker</code>'s
  <span> volume multiplier</span> to the new value. If the new value is outside the
  range 0.0 to 1.0 inclusive, then, on setting, an
  <code>INDEX_SIZE_ERR</code> exception must be raised instead.</p>

	<p>The <dfn title="speaker-on"><code>on</code></dfn> method when invoked must run the following steps:

<ol>
	<li><p>Send a request to the speaker control system to turn the speaker on.  
</ol>

<p>The <dfn title="speaker-off"><code>on</code></dfn> method when invoked must run the following steps:

<ol>
	<li><p>Send a request to the speaker control system to turn the speaker off.  
</ol>

</div>

<h3>The Microphone interface</h3>

<p>The <code>Microphone</code> interface allows to control the microphone hardware associated to telephone calls.

<pre class="idl">
interface <dfn>Microphone</dfn> {
  void <span title="mic-mute">mute</span>();
  void <span title="mic-unumte">unmute</span>();
 
  attribute double <span title="mic-volume">volume</span>;
}
</pre>


<dl class="domintro">
  <dt><var title="">mic</var> . <code title="speaker-on">mute</code>()</dt>
    <dd>
        <p>Request to mute the mic</p>
   </dd>

  <dt><var title="">mic</var> . <code title="speaker-off">unmute</code>()</dt>
    <dd>
        <p>Request to unmute the mic</p>
   </dd>

  <dt><var title="">mic</var> . <code title="speaker-off">volume</code></dt>
    <dd>
        <p>Returns the current mic volume multiplier, as a number in
    the range 0.0 to 1.0, where 0.0 is the quietest and 1.0 the
    loudest.

<p>Can be set, to change the volume multiplier.</p>

    <p>Throws an <code>INDEX_SIZE_ERR</code> if the new value is not
    in the range 0.0 .. 1.0.</p>

   </dd>
</dl>


<div class="impl">
<p>The <dfn title="mic-volume"><code>volume</code></dfn> attribute 
  attribute, on getting, must return the   <code>Microphone</code>'s <span> volume
  multiplier</span>, and on setting, if the new value is in the range
  0.0 to 1.0 inclusive, must set the <code>Microphone</code>'s
  <span> volume multiplier</span> to the new value. If the new value is outside the
  range 0.0 to 1.0 inclusive, then, on setting, an
  <code>INDEX_SIZE_ERR</code> exception must be raised instead.</p>

<p>The <dfn title="mic-mute"><code>mute</code></dfn> method when invoked must run the following steps:

<ol>
	<li><p>Send a request to the microphone control system to be muted.  
</ol>

<p>The <dfn title="mic-unmute"><code>unmute</code></dfn> method when invoked must run the following steps:

<ol>
	<li><p>Send a request to the microphone control system to be unmuted.  
</ol>

</div>

<h3>The IncomingCallEvent</h3>

<pre class="idl">
interface <dfn>IncomingCallEvent</dfn> : Event {
   readonly attribute Call call;
}
</pre>


<h2 class="no-num">Acknowledgements</h2>

<p>WAC Device Specs AC
